{% extends "base.html" %}

{% block title %}Audit Logs - Lifecycle AI{% endblock %}

{% block content %}
<div class="page-container fadeIn">
    <div class="header-section">
        <h1>Comprehensive Audit Logs</h1>
        <p>A detailed record of all automated employee lifecycle events.</p>
    </div>

    <div class="filters-container glass" style="flex-direction: column; align-items: stretch; gap: 15px;">
        <div style="display: flex; gap: 20px; align-items: center;">
            <div class="search-box" style="flex: 2;">
                <i class="fas fa-search"></i>
                <input type="text" id="log-search" placeholder="Search by employee name, action, or team...">
            </div>
            <div style="flex: 1; display: flex; gap: 10px;">
                <input type="date" id="start-date" class="glass-input"
                    style="background: rgba(15, 23, 42, 0.4); border: 1px solid var(--border-color); color: white; padding: 10px; border-radius: 8px;">
                <input type="date" id="end-date" class="glass-input"
                    style="background: rgba(15, 23, 42, 0.4); border: 1px solid var(--border-color); color: white; padding: 10px; border-radius: 8px;">
            </div>
        </div>
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div class="filter-pills">
                <span class="pill active" data-filter="all">All</span>
                <span class="pill" data-filter="ONBOARDING">Onboarding</span>
                <span class="pill" data-filter="OFFBOARDING">Offboarding</span>
                <span class="pill" data-filter="TRANSFER">Transfers</span>
                <span class="pill" data-filter="REQUEST_COMPLETED">System</span>
            </div>
            <button class="btn-secondary" id="clear-filters">Clear Filters</button>
        </div>
    </div>

    <div class="timeline-container" id="audit-timeline">
        <!-- Logs will be dynamically loaded here -->
        <div class="loading-state">
            <div class="spinner"></div>
            <p>Gathering logs from the ledger...</p>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const timeline = document.getElementById('audit-timeline');
        const searchInput = document.getElementById('log-search');
        const startDate = document.getElementById('start-date');
        const endDate = document.getElementById('end-date');
        const clearBtn = document.getElementById('clear-filters');
        const pills = document.querySelectorAll('.pill');
        let allLogs = [];

        async function fetchLogs() {
            try {
                const response = await fetch('/api/logs');
                allLogs = await response.json();
                renderLogs(allLogs);
            } catch (e) {
                timeline.innerHTML = '<div class="error">Failed to load logs.</div>';
            }
        }

        function renderLogs(logs) {
            timeline.innerHTML = '';
            if (logs.length === 0) {
                timeline.innerHTML = '<div class="empty-state" style="text-align: center; padding: 40px; color: var(--text-secondary);">No matching logs found for the selected criteria.</div>';
                return;
            }

            logs.slice().reverse().forEach((log, index) => {
                const item = document.createElement('div');
                item.className = 'timeline-item glass-hover';
                item.style.animationDelay = `${index * 0.05}s`;

                const date = new Date(log.timestamp);
                const dateStr = date.toLocaleDateString();
                const timeStr = date.toLocaleTimeString();

                item.innerHTML = `
                <div class="timeline-dot"></div>
                <div class="timeline-content">
                    <div class="log-header">
                        <span class="log-type ${log.event_type.toLowerCase()}">${log.event_type.replace('_', ' ')}</span>
                        <span class="log-time">${dateStr} ${timeStr}</span>
                    </div>
                    <div class="log-details">
                        <div style="display: grid; grid-template-columns: 80px 1fr; gap: 5px;">
                            <span style="color: var(--text-secondary)">Action:</span> <strong>${log.details.action || (log.event_type.includes('COMPLETED') ? 'Request Finalized' : 'Process Log')}</strong>
                            <span style="color: var(--text-secondary)">Subject:</span> <span>${log.details.employee_name || log.details.person_name || 'System Auto'}</span>
                            <span style="color: var(--text-secondary)">Context:</span> <span>${log.details.target_team || log.details.target_role || log.details.intent || 'Infrastructure'}</span>
                        </div>
                    </div>
                </div>
            `;
                timeline.appendChild(item);
            });
        }

        function filterLogs() {
            const searchTerm = searchInput.value.toLowerCase();
            const start = startDate.value;
            const end = endDate.value;
            const activeFilter = document.querySelector('.pill.active').dataset.filter;

            const filtered = allLogs.filter(log => {
                const logData = JSON.stringify(log).toLowerCase();
                const matchesSearch = logData.includes(searchTerm);

                const logDate = log.timestamp.split('T')[0];
                const matchesStart = !start || logDate >= start;
                const matchesEnd = !end || logDate <= end;

                let matchesFilter = activeFilter === 'all';
                if (!matchesFilter) {
                    if (activeFilter === 'TRANSFER') {
                        matchesFilter = log.event_type === 'TRANSFER' || (log.details.intent === 'Team Transfer');
                    } else {
                        matchesFilter = log.event_type === activeFilter || (log.details.intent === activeFilter);
                    }
                }

                return matchesSearch && matchesStart && matchesEnd && matchesFilter;
            });

            renderLogs(filtered);
        }

        [searchInput, startDate, endDate].forEach(el => el.addEventListener('input', filterLogs));

        pills.forEach(pill => {
            pill.addEventListener('click', () => {
                pills.forEach(p => p.classList.remove('active'));
                pill.classList.add('active');
                filterLogs();
            });
        });

        clearBtn.addEventListener('click', () => {
            searchInput.value = '';
            startDate.value = '';
            endDate.value = '';
            pills.forEach(p => p.classList.remove('active'));
            pills[0].classList.add('active');
            filterLogs();
        });

        fetchLogs();
    });
</script>
{% endblock %}